generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id          String        @id @default(cuid())
  email       String        @unique
  name        String?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  connections Connection[]
  subscription Subscription?
  playbooks   Playbook[]
}

enum PlanType {
  STARTER
  GROWTH
  PRO
  ENTERPRISE
  TRIAL
}

model Subscription {
  id            String    @id @default(cuid())
  userId        String    @unique
  planType      PlanType  @default(TRIAL)
  status        String    @default("active") // active, cancelled, expired, past_due
  currentPeriodStart DateTime @default(now())
  currentPeriodEnd   DateTime
  canceledAt    DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  // Payment gateway information
  paymentGateway String?  // razorpay, paddle, etc.
  gatewaySubscriptionId String? // Razorpay subscription ID
  gatewayCustomerId String? // Razorpay customer ID
  gatewayPlanId String? // Razorpay plan ID
  metadata     Json? // Additional payment metadata
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  usageRecords  UsageRecord[]
  
  @@index([gatewaySubscriptionId])
  @@index([gatewayCustomerId])
}

model UsageRecord {
  id            String    @id @default(cuid())
  subscriptionId String
  periodStart   DateTime  // Start of billing period
  periodEnd     DateTime  // End of billing period
  emailsSent    Int       @default(0)
  emailsReceived Int      @default(0)
  aiSuggestions Int       @default(0)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  subscription Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  @@unique([subscriptionId, periodStart])
  @@index([subscriptionId, periodStart])
}

model Connection {
  id           String         @id @default(cuid())
  type         ConnectionType
  accessToken  String
  refreshToken String?
  shopDomain   String?
  metadata     Json?
  userId       String
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  user         User           @relation(fields: [userId], references: [id])
  orders       Order[]
  threads      Thread[]
}

model Order {
  id           String     @id @default(cuid())
  shopifyId    String     @unique
  status       String
  email        String?
  totalAmount  Int
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  shopDomain   String?
  name         String?
  connectionId String
  actions      Action[]
  messages     Message[]
  connection   Connection @relation(fields: [connectionId], references: [id])
}

model Thread {
  id            String     @id @default(cuid())
  subject       String?
  customerEmail String
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt
  connectionId  String
  messages      Message[]
  connection    Connection @relation(fields: [connectionId], references: [id])
}

model Message {
  id           String           @id @default(cuid())
  threadId     String
  orderId      String?
  from         String
  to           String
  body         String
  direction    MessageDirection
  createdAt    DateTime         @default(now())
  headers      Json?
  messageId    String?          @unique
  aiSuggestion AISuggestion?
  order        Order?           @relation(fields: [orderId], references: [id])
  thread       Thread           @relation(fields: [threadId], references: [id])
}

model AISuggestion {
  id             String     @id @default(cuid())
  messageId      String     @unique
  reply          String
  proposedAction ActionType
  orderId        String?
  confidence     Float
  createdAt      DateTime   @default(now())
  message        Message    @relation(fields: [messageId], references: [id])
}

model Action {
  id         String       @id @default(cuid())
  orderId    String
  type       ActionType
  status     ActionStatus @default(PENDING)
  payload    Json?
  createdAt  DateTime     @default(now())
  executedAt DateTime?
  order      Order        @relation(fields: [orderId], references: [id])
}

model Event {
  id        String   @id @default(cuid())
  type      String
  entity    String?
  entityId  String?
  payload   Json?
  createdAt DateTime @default(now())
}

model Playbook {
  id                  String            @id @default(cuid())
  userId              String
  name                String
  description         String?
  category            PlaybookCategory
  trigger             Json              // { type: 'shopify_event' | 'email_intent' | 'scheduled', config: {...} }
  conditions          Json              // Array of condition objects
  actions             Json              // Array of action objects
  confidenceThreshold Float             @default(0.8)
  requiresApproval    Boolean           @default(false)
  enabled             Boolean           @default(false)
  isDefault           Boolean           @default(false) // Default playbooks provided by system
  executionCount      Int               @default(0)
  lastExecutedAt      DateTime?
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt
  user                User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  executions          PlaybookExecution[]

  @@index([userId, category])
  @@index([enabled])
}

model PlaybookExecution {
  id          String   @id @default(cuid())
  playbookId  String
  status      String   // pending, approved, executed, rejected, failed
  confidence  Float?
  triggerData Json     // Data that triggered the execution
  result      Json?    // Result of execution
  error       String?
  createdAt   DateTime @default(now())
  executedAt  DateTime?
  playbook    Playbook @relation(fields: [playbookId], references: [id], onDelete: Cascade)

  @@index([playbookId, createdAt])
  @@index([status])
}

enum ConnectionType {
  SHOPIFY
  GMAIL
  CUSTOM_EMAIL
  META_ADS
  GOOGLE_ADS
  GOOGLE_ANALYTICS
}

enum PlaybookCategory {
  REFUND_RETURN
  MARKETING
  FULFILLMENT
  SUPPORT
  INVENTORY
  CUSTOM
}

enum MessageDirection {
  INBOUND
  OUTBOUND
}

enum ActionType {
  REFUND
  CANCEL
  REPLACE_ITEM
  ADDRESS_CHANGE
  INFO_REQUEST
  NONE
}

enum ActionStatus {
  PENDING
  APPROVED
  REJECTED
  EXECUTED
}
