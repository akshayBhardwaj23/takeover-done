generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id          String       @id @default(cuid())
  email       String       @unique
  name        String?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  connections Connection[]
}

model Connection {
  id           String         @id @default(cuid())
  type         ConnectionType
  accessToken  String
  refreshToken String?
  shopDomain   String?
  metadata     Json?
  userId       String
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  user         User           @relation(fields: [userId], references: [id])
  orders       Order[]
  threads      Thread[]
}

model Order {
  id           String     @id @default(cuid())
  shopifyId    String     @unique
  status       String
  email        String?
  totalAmount  Int
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  shopDomain   String?
  name         String?
  connectionId String
  actions      Action[]
  messages     Message[]
  connection   Connection @relation(fields: [connectionId], references: [id])
}

model Thread {
  id            String     @id @default(cuid())
  subject       String?
  customerEmail String
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt
  connectionId  String
  messages      Message[]
  connection    Connection @relation(fields: [connectionId], references: [id])
}

model Message {
  id           String           @id @default(cuid())
  threadId     String
  orderId      String?
  from         String
  to           String
  body         String
  direction    MessageDirection
  createdAt    DateTime         @default(now())
  headers      Json?
  messageId    String?          @unique
  aiSuggestion AISuggestion?
  order        Order?           @relation(fields: [orderId], references: [id])
  thread       Thread           @relation(fields: [threadId], references: [id])
}

model AISuggestion {
  id             String     @id @default(cuid())
  messageId      String     @unique
  reply          String
  proposedAction ActionType
  orderId        String?
  confidence     Float
  createdAt      DateTime   @default(now())
  message        Message    @relation(fields: [messageId], references: [id])
}

model Action {
  id         String       @id @default(cuid())
  orderId    String
  type       ActionType
  status     ActionStatus @default(PENDING)
  payload    Json?
  createdAt  DateTime     @default(now())
  executedAt DateTime?
  order      Order        @relation(fields: [orderId], references: [id])
}

model Event {
  id        String   @id @default(cuid())
  type      String
  entity    String?
  entityId  String?
  payload   Json?
  createdAt DateTime @default(now())
}

enum ConnectionType {
  SHOPIFY
  GMAIL
  CUSTOM_EMAIL
}

enum MessageDirection {
  INBOUND
  OUTBOUND
}

enum ActionType {
  REFUND
  CANCEL
  REPLACE_ITEM
  ADDRESS_CHANGE
  INFO_REQUEST
  NONE
}

enum ActionStatus {
  PENDING
  APPROVED
  REJECTED
  EXECUTED
}
